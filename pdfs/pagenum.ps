%!PS

% Copyright (C) 2005 Godfrey Livingstone

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% use as follows
%
% gs <options> -f pagenum.ps -f <postscript or pdf files to add page
% number to>
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Set Page Count to 1 do not alter
currentglobal true setglobal globaldict/MyPageCount 1 put setglobal

/_showpage_ /showpage load def

/showpage
{
  currentglobal true setglobal
  globaldict begin
  /MyPageCount MyPageCount 1 add def
  end
  setglobal
  _showpage_
}bind def

% set a page counter check, ghostscript
% when printing pdf's does not appear to call showpage

currentglobal true setglobal globaldict/MyPageCount_Check MyPageCount put
setglobal

% Set the current date unless overridden

currentglobal true setglobal globaldict/MyDateString
        (%Calendar%) currentdevparams dup % get dic and duplicate
        /Day get =string cvs % find the day, convert to string
        1 index /Month get 1 sub  % put a copy of dic at top of stack
        {( January )( February )( March )( April )( May )( June )( July )(
August )
        ( September )( October )( November )( December )} exch get
        % get the month as written
             concatstrings % merge day and month
        exch /Year get =string cvs % bring dict to top, get year and convert to string
        concatstrings % merge day and month and year
put setglobal

% load letterhead on demand, only load once
currentglobal true setglobal globaldict/Load_MyLetterHeadD_True         1 put
setglobal

% No letterhead at all is the default
currentglobal true setglobal globaldict/LetterHead_Number_Set [0] put
setglobal

/MyLetterHeadPageNum
{
        2 eq % if called by endpage subtract 1
        { MyPageCount 1 sub }
        { MyPageCount }
        ifelse
        currentpagedevice /PageSize get aload pop pop
        % put the page width on the stack
        exch % page number and page width
        dup   % stack now contains  page width, page number, page number
        3 1 roll   % stack now contains page number, page width, page number
        =string cvs length 12 mul 20 add sub % stack now contains page number and xpos
        25 moveto /Times-Roman 12 selectfont 0 0 0 setrgbcolor =string
% cvs 
cvs show
}bind def

/Load_MyLetterHeadD
{
        [ /BBox [0 0 100 100] /_objdef {date_logo} /BP pdfmark
                % bottom left corner of a page
                20 20 moveto /Times-Roman 12 selectfont 0 0 0 setrgbcolor
% MyDateString show
        [ /EP pdfmark
        currentglobal true setglobal globaldict/Load_MyLetterHeadD_True 0 put
setglobal
}bind def

/MyLetterHeadD
{
        Load_MyLetterHeadD_True 1 eq
        {
              Load_MyLetterHeadD
        }
        if
        0 0 moveto
        [ {date_logo} /SP pdfmark
}bind def

/MyDoLetterHead
{
        % get the varible called
        /my_begin_or_end_page_var exch def

        % This is a hack as ghostscript when printing
        % pdf's does not appear to call showpage

        MyPageCount MyPageCount_Check eq my_begin_or_end_page_var 2 eq and
        {
                currentglobal true setglobal
                globaldict begin
                /MyPageCount MyPageCount 1 add def
                /MyPageCount_Check MyPageCount def
                end
                setglobal
        }
        {
                currentglobal true setglobal globaldict/MyPageCount_Check
MyPageCount
put setglobal
        }
        ifelse

        % instructions passed as an array so foreach
        % element of the array do as instructed
        % note LetterHead_Number_Set is an array

        LetterHead_Number_Set  %forall
        {
        dup 10 idiv
        /LetterHead_Number exch def
        10 mod
        /my_water_or_stamp_var exch def

        % if we are stamping only apply if endpage
        % likewise if watermark only apply if beginpage
        % define what is to be stamped as none otherwise

        my_begin_or_end_page_var  my_water_or_stamp_var ne {
/LetterHead_Number 0
def } if

        LetterHead_Number 1 eq % Date
        {
                MyLetterHeadD
        } if
       LetterHead_Number 2 eq % Number Pages
        {
                my_begin_or_end_page_var MyLetterHeadPageNum
        } if
        } forall
}bind def


% format LLW
%        LL Letterhead to apply
%        W whether watermark (1) or stamp (2)
% Letterhead numbers
% 01 Date
% 02 Page Numbers at top of the page

% the example below will apply a stamp of the
% date and stamp page numbers on each page

currentglobal true setglobal globaldict/LetterHead_Number_Set [012 022]
put setglobal


% Note: Watermarking dooes not deal with
% pages size changes very well but stamping does


% These lines must be at the end of the file

<< /BeginPage { pop 1 MyDoLetterHead } bind >> setpagedevice

% using initmatrix is necessary because of the condition the
% windows ps driver leaves the current matrix in

<< /EndPage { 0 ne {false} { pop gsave initmatrix 2 MyDoLetterHead
grestore true} ifelse } bind >> setpagedevice

